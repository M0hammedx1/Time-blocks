<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimePlanner - Mohammed Islam Edition</title>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; overflow-x: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }

        /* Animations */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-pop { animation: fadeInScale 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide { animation: slideDown 0.2s ease-out forwards; }

        /* Glassmorphism & Gradients */
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .dark .glass-panel {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Print Styles */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .glass-panel { background: white !important; border: 1px solid #eee !important; box-shadow: none !important; backdrop-filter: none !important; }
            .print-break { page-break-inside: avoid; }
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        trueBlack: '#050505',
                        darkCard: '#121212',
                    },
                    boxShadow: {
                        'glow': '0 0 25px rgba(var(--theme-color), 0.2)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-100 text-slate-900 transition-colors duration-500 selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Configuration ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        // Modern Gradients for Themes
        const THEMES = [
            { id: 'indigo', name: 'ملكي', primary: 'from-indigo-600 to-violet-600', accent: 'text-indigo-600', ring: 'ring-indigo-500', shadow: 'shadow-indigo-500/30' },
            { id: 'rose', name: 'حيوي', primary: 'from-rose-500 to-pink-600', accent: 'text-rose-600', ring: 'ring-rose-500', shadow: 'shadow-rose-500/30' },
            { id: 'emerald', name: 'طبيعة', primary: 'from-emerald-500 to-teal-600', accent: 'text-emerald-600', ring: 'ring-emerald-500', shadow: 'shadow-emerald-500/30' },
            { id: 'amber', name: 'دافيء', primary: 'from-amber-500 to-orange-600', accent: 'text-amber-600', ring: 'ring-amber-500', shadow: 'shadow-amber-500/30' },
            { id: 'sky', name: 'سماء', primary: 'from-sky-500 to-blue-600', accent: 'text-sky-600', ring: 'ring-sky-500', shadow: 'shadow-sky-500/30' },
            { id: 'slate', name: 'رسمي', primary: 'from-slate-700 to-slate-900', accent: 'text-slate-700', ring: 'ring-slate-500', shadow: 'shadow-slate-500/30' },
        ];

        const CAT_STYLES = [
            { id: 0, bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-600 dark:text-blue-400', border: 'border-blue-500' },
            { id: 1, bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-600 dark:text-red-400', border: 'border-red-500' },
            { id: 2, bg: 'bg-emerald-100 dark:bg-emerald-900/30', text: 'text-emerald-600 dark:text-emerald-400', border: 'border-emerald-500' },
            { id: 3, bg: 'bg-violet-100 dark:bg-violet-900/30', text: 'text-violet-600 dark:text-violet-400', border: 'border-violet-500' },
            { id: 4, bg: 'bg-amber-100 dark:bg-amber-900/30', text: 'text-amber-600 dark:text-amber-400', border: 'border-amber-500' },
            { id: 5, bg: 'bg-pink-100 dark:bg-pink-900/30', text: 'text-pink-600 dark:text-pink-400', border: 'border-pink-500' },
        ];

        const ICONS = ['briefcase', 'book-open', 'coffee', 'zap', 'activity', 'users', 'home', 'music', 'code', 'pen-tool', 'sun', 'moon', 'star', 'heart'];

        // --- Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const App = () => {
            // --- State ---
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('mi_tasks')) || []);
            const [categories, setCategories] = useState(() => JSON.parse(localStorage.getItem('mi_cats')) || [
                { id: 'work', label: 'عمل', styleIdx: 0, icon: 'briefcase' },
                { id: 'learn', label: 'تطوير ذات', styleIdx: 3, icon: 'book-open' },
                { id: 'rest', label: 'راحة', styleIdx: 2, icon: 'coffee' },
            ]);
            const [mainGoal, setMainGoal] = useState(() => localStorage.getItem('mi_goal') || "");
            const [theme, setTheme] = useState(() => THEMES.find(t => t.id === localStorage.getItem('mi_theme')) || THEMES[0]);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('mi_dark') === 'true');
            
            // UI Toggles
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showThemes, setShowThemes] = useState(false); // Explicit toggle for themes
            
            const [currentTask, setCurrentTask] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [formData, setFormData] = useState({ title: '', startTime: '09:00', endTime: '10:00', category: '', notes: '' });

            // --- Effects ---
            useEffect(() => { localStorage.setItem('mi_tasks', JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem('mi_cats', JSON.stringify(categories)); }, [categories]);
            useEffect(() => { localStorage.setItem('mi_goal', mainGoal); }, [mainGoal]);
            useEffect(() => { localStorage.setItem('mi_theme', theme.id); }, [theme]);
            useEffect(() => {
                localStorage.setItem('mi_dark', darkMode);
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            // --- Time Logic (12h & Cross-Midnight) ---
            
            // Convert 24h string "14:30" to 12h "02:30 م"
            const formatTime12 = (time24) => {
                if (!time24) return "";
                const [h, m] = time24.split(':').map(Number);
                const ampm = h >= 12 ? 'م' : 'ص';
                const h12 = h % 12 || 12;
                return `${h12}:${m.toString().padStart(2, '0')} ${ampm}`;
            };

            // Calculate duration handling midnight crossing
            const getDurationMins = (start, end) => {
                const [h1, m1] = start.split(':').map(Number);
                const [h2, m2] = end.split(':').map(Number);
                let totalStart = h1 * 60 + m1;
                let totalEnd = h2 * 60 + m2;
                
                // If end is smaller than start, assume it's next day (cross midnight)
                if (totalEnd < totalStart) {
                    totalEnd += 24 * 60;
                }
                
                return totalEnd - totalStart;
            };

            const formatDuration = (mins) => {
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                if (h > 0 && m > 0) return `${h}س ${m}د`;
                if (h > 0) return `${h} ساعة`;
                return `${m} دقيقة`;
            };

            const sortedTasks = useMemo(() => [...tasks].sort((a, b) => a.startTime.localeCompare(b.startTime)), [tasks]);
            
            const stats = useMemo(() => {
                const data = {};
                let total = 0;
                tasks.forEach(t => {
                    const d = getDurationMins(t.startTime, t.endTime);
                    data[t.category] = (data[t.category] || 0) + d;
                    total += d;
                });
                return { data, total };
            }, [tasks]);

            // --- Actions ---
            const handleSave = (e) => {
                e.preventDefault();
                const catId = formData.category || categories[0].id;
                const taskData = { ...formData, category: catId };
                if (currentTask) setTasks(tasks.map(t => t.id === currentTask.id ? { ...taskData, id: t.id } : t));
                else setTasks([...tasks, { ...taskData, id: generateId() }]);
                setIsModalOpen(false);
            };

            const openModal = (task = null) => {
                if (task) {
                    setCurrentTask(task);
                    setFormData(task);
                } else {
                    setCurrentTask(null);
                    // Default logic
                    let nextStart = "09:00";
                    if (sortedTasks.length > 0) {
                         const lastTask = sortedTasks[sortedTasks.length - 1];
                         nextStart = lastTask.endTime;
                    }
                    // Add 1 hour
                    const [h, m] = nextStart.split(':').map(Number);
                    let endH = (h + 1) % 24;
                    const nextEnd = `${endH.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                    
                    setFormData({ title: '', startTime: nextStart, endTime: nextEnd, category: categories[0].id, notes: '' });
                }
                setIsModalOpen(true);
            };

            const exportJSON = () => {
                const data = JSON.stringify({ tasks, categories, mainGoal, theme: theme.id }, null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `MohammedIslam_Plan_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            };

            const importJSON = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const json = JSON.parse(event.target.result);
                            if (json.tasks) setTasks(json.tasks);
                            if (json.categories) setCategories(json.categories);
                            if (json.mainGoal) setMainGoal(json.mainGoal);
                            if (json.theme) setTheme(THEMES.find(t => t.id === json.theme) || THEMES[0]);
                            alert('تم استعادة النسخة الاحتياطية بنجاح!');
                        } catch (err) { alert('ملف غير صالح'); }
                    };
                    reader.readAsText(e.target.files[0]);
                };
                input.click();
            };

            return (
                <div className={`min-h-screen flex flex-col ${darkMode ? 'bg-trueBlack text-slate-100' : 'bg-slate-100 text-slate-800'}`}>
                    
                    {/* Ambient Background */}
                    <div className={`fixed top-0 left-0 w-full h-96 bg-gradient-to-b ${theme.primary} opacity-10 blur-3xl pointer-events-none`}></div>

                    {/* Navbar */}
                    <nav className={`sticky top-0 z-40 px-4 md:px-6 py-3 glass-panel border-b-0 no-print transition-all`}>
                        <div className="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-3">
                            <div className="flex items-center gap-3">
                                <div className={`w-11 h-11 rounded-2xl bg-gradient-to-br ${theme.primary} flex items-center justify-center text-white shadow-lg ${theme.shadow}`}>
                                    <Icon name="hourglass" size={22} />
                                </div>
                                <div>
                                    <h1 className="text-xl md:text-2xl font-black tracking-tight leading-none">TimePlanner</h1>
                                    <div className="flex items-center gap-1 mt-1">
                                        <span className={`text-[9px] md:text-[10px] uppercase font-bold px-2 py-0.5 rounded-full bg-gradient-to-r ${theme.primary} text-white shadow-sm`}>
                                            Mohammed Islam edition
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center gap-2">
                                {/* Theme Toggle Button - VERY VISIBLE NOW */}
                                <button 
                                    onClick={() => setShowThemes(!showThemes)} 
                                    className={`p-2.5 rounded-xl transition-all flex items-center gap-2 ${showThemes ? 'bg-white text-black shadow-md' : 'hover:bg-slate-200/50 dark:hover:bg-white/10'}`}
                                    title="تغيير الألوان"
                                >
                                    <Icon name="palette" size={20} />
                                </button>

                                <div className="h-6 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>

                                <button onClick={() => setDarkMode(!darkMode)} className="p-2.5 rounded-xl hover:bg-slate-200/50 dark:hover:bg-white/10 transition-colors">
                                    {darkMode ? <Icon name="sun" size={20} /> : <Icon name="moon" size={20} />}
                                </button>
                                
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2.5 rounded-xl hover:bg-slate-200/50 dark:hover:bg-white/10 transition-colors">
                                    <Icon name="settings-2" size={20} />
                                </button>

                                <button 
                                    onClick={() => window.print()} 
                                    className={`hidden md:flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r ${theme.primary} hover:opacity-90 transition-all active:scale-95`}
                                >
                                    <Icon name="printer" size={18} />
                                    <span>PDF</span>
                                </button>
                            </div>
                        </div>

                        {/* Theme Palette Drawer */}
                        {showThemes && (
                            <div className="max-w-7xl mx-auto mt-4 animate-slide border-t border-slate-200/50 dark:border-white/10 pt-3">
                                <div className="flex flex-wrap gap-3 items-center justify-center md:justify-start">
                                    <span className="text-xs font-bold opacity-50 ml-2">اختر لونك المفضل:</span>
                                    {THEMES.map(t => (
                                        <button 
                                            key={t.id}
                                            onClick={() => setTheme(t)}
                                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all ${theme.id === t.id ? 'border-current bg-white/10 shadow-sm' : 'border-transparent hover:bg-white/5'}`}
                                        >
                                            <div className={`w-5 h-5 rounded-full bg-gradient-to-br ${t.primary} shadow-sm`}></div>
                                            <span className="text-xs font-bold">{t.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </nav>

                    {/* Main Content */}
                    <main className="flex-1 w-full max-w-7xl mx-auto p-4 lg:p-8 flex flex-col lg:flex-row gap-8 relative z-10">
                        
                        {/* Sidebar */}
                        <aside className="lg:w-[350px] space-y-6 print-break">
                            {/* Goal Card */}
                            <div className={`p-6 rounded-3xl glass-panel shadow-sm relative overflow-hidden group`}>
                                <div className={`absolute top-0 right-0 w-24 h-24 bg-gradient-to-br ${theme.primary} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                                <div className="relative z-10">
                                    <div className="flex items-center gap-2 mb-3 opacity-70">
                                        <Icon name="target" size={18} className={theme.accent} />
                                        <span className="text-xs font-bold uppercase tracking-wider">هدف اليوم</span>
                                    </div>
                                    <textarea 
                                        value={mainGoal}
                                        onChange={(e) => setMainGoal(e.target.value)}
                                        placeholder="ما هو إنجازك العظيم اليوم؟"
                                        rows="2"
                                        className={`w-full bg-transparent text-xl font-bold resize-none outline-none placeholder-slate-300 dark:placeholder-slate-700`}
                                    ></textarea>
                                </div>
                            </div>

                            {/* Stats */}
                            <div className="p-6 rounded-3xl glass-panel shadow-sm">
                                <div className="flex justify-between items-end mb-6">
                                    <div>
                                        <h3 className="font-bold text-lg">تحليل الأداء</h3>
                                    </div>
                                    <div className="text-2xl font-black font-mono dir-ltr">
                                        {Math.floor(stats.total/60)}h {stats.total%60}m
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    {categories.map(cat => {
                                        const mins = stats.data[cat.id] || 0;
                                        const percent = stats.total > 0 ? Math.round((mins/stats.total)*100) : 0;
                                        const style = CAT_STYLES[cat.styleIdx % CAT_STYLES.length];
                                        if (stats.total > 0 && mins === 0) return null;
                                        return (
                                            <div key={cat.id}>
                                                <div className="flex justify-between text-xs mb-1.5 font-medium">
                                                    <span className="flex items-center gap-2"><Icon name={cat.icon} size={14} className={style.text}/> {cat.label}</span>
                                                    <span className="opacity-50">{formatDuration(mins)}</span>
                                                </div>
                                                <div className="h-2 w-full bg-slate-100 dark:bg-white/5 rounded-full overflow-hidden">
                                                    <div className={`h-full rounded-full transition-all duration-1000 ${theme.id === 'slate' ? 'bg-slate-600' : style.text.replace('text', 'bg')}`} style={{width: `${percent}%`}}></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {stats.total === 0 && <p className="text-center text-sm opacity-40 py-4">لا توجد بيانات</p>}
                                </div>
                            </div>

                            {/* Backup Buttons */}
                            <div className="grid grid-cols-2 gap-3 no-print">
                                <button onClick={exportJSON} className="p-3 rounded-2xl glass-panel hover:bg-white dark:hover:bg-white/10 transition-colors flex items-center justify-center gap-2 text-xs font-bold opacity-70 hover:opacity-100">
                                    <Icon name="download" size={16} /> حفظ نسخة
                                </button>
                                <button onClick={importJSON} className="p-3 rounded-2xl glass-panel hover:bg-white dark:hover:bg-white/10 transition-colors flex items-center justify-center gap-2 text-xs font-bold opacity-70 hover:opacity-100">
                                    <Icon name="upload" size={16} /> استعادة
                                </button>
                            </div>

                            <button 
                                onClick={() => openModal()}
                                className={`w-full py-4 rounded-2xl bg-gradient-to-r ${theme.primary} text-white font-bold shadow-lg ${theme.shadow} flex items-center justify-center gap-2 transform transition-all hover:scale-[1.02] active:scale-95 no-print`}
                            >
                                <Icon name="plus-circle" size={20} />
                                إضافة مهمة جديدة
                            </button>
                        </aside>

                        {/* Timeline */}
                        <section className="flex-1 p-6 lg:p-8 rounded-3xl glass-panel shadow-sm min-h-[600px] relative">
                            <header className="flex justify-between items-center mb-8 border-b border-slate-200/50 dark:border-white/10 pb-4">
                                <div>
                                    <h2 className="text-2xl font-bold mb-1">الجدول الزمني</h2>
                                    <p className="text-sm opacity-50">{currentTime.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                </div>
                                <div className="text-xs font-mono bg-slate-100 dark:bg-white/10 px-3 py-1 rounded-full opacity-60">
                                    {tasks.length} Tasks
                                </div>
                            </header>

                            <div className="absolute right-[5.5rem] top-32 bottom-10 w-0.5 bg-slate-200 dark:bg-white/10"></div>

                            <div className="space-y-6 relative">
                                {sortedTasks.map((task, idx) => {
                                    const cat = categories.find(c => c.id === task.category) || categories[0];
                                    const style = CAT_STYLES[cat.styleIdx % CAT_STYLES.length];
                                    const durationMins = getDurationMins(task.startTime, task.endTime);
                                    
                                    // Overlap Check
                                    let overlap = false;
                                    if (idx > 0 && task.startTime < sortedTasks[idx-1].endTime) overlap = true;
                                    
                                    // Cross Midnight Check for Badge
                                    const crossesMidnight = task.endTime < task.startTime;

                                    return (
                                        <div key={task.id} onClick={() => openModal(task)} className="group flex gap-6 relative cursor-pointer animate-pop" style={{ animationDelay: `${idx * 0.05}s` }}>
                                            {/* Time Column (12h Format) */}
                                            <div className="flex flex-col items-center min-w-[100px] pt-1">
                                                <span className={`text-lg font-bold tracking-tight ${theme.accent} font-mono`}>{formatTime12(task.startTime)}</span>
                                                <span className="text-[10px] font-medium opacity-40 mt-1">{formatDuration(durationMins)}</span>
                                                {overlap && <span className="mt-1 text-[9px] bg-red-500 text-white px-1.5 py-0.5 rounded-md animate-pulse">تداخل!</span>}
                                                {crossesMidnight && <span className="mt-1 text-[9px] bg-indigo-500 text-white px-1.5 py-0.5 rounded-md flex items-center gap-1"><Icon name="moon" size={8}/> لليوم التالي</span>}
                                            </div>

                                            {/* Dot */}
                                            <div className={`absolute right-[5.1rem] top-3 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-slate-800 ${theme.id === 'slate' ? 'bg-slate-500' : style.text.replace('text', 'bg')} shadow-sm z-10 transition-transform group-hover:scale-125`}></div>

                                            {/* Card */}
                                            <div className={`flex-1 p-5 rounded-2xl border-r-4 transition-all duration-300 group-hover:translate-x-[-5px] ${darkMode ? 'bg-white/5 hover:bg-white/10' : 'bg-white hover:bg-slate-50'} border-slate-100 dark:border-white/5 shadow-sm hover:shadow-md ${style.border}`}>
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[11px] font-bold mb-2 ${style.bg} ${style.text}`}>
                                                            <Icon name={cat.icon} size={12} /> {cat.label}
                                                        </div>
                                                        <h3 className="font-bold text-xl leading-tight mb-1">{task.title}</h3>
                                                        {task.notes && <p className="text-sm opacity-60 leading-relaxed">{task.notes}</p>}
                                                    </div>
                                                    <span className="text-xs font-mono opacity-30 group-hover:opacity-100 transition-opacity">{formatTime12(task.endTime)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                                {tasks.length === 0 && (
                                    <div className="text-center py-24 opacity-40 flex flex-col items-center">
                                        <Icon name="layout-list" size={48} className="mb-4 opacity-50"/>
                                        <p className="text-lg font-medium">ابدأ يومك بتخطيط ذكي!</p>
                                    </div>
                                )}
                            </div>
                        </section>
                    </main>

                    {/* --- Task Modal --- */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-pop no-print">
                            <div className={`w-full max-w-lg rounded-3xl shadow-2xl p-8 relative overflow-hidden ${darkMode ? 'bg-darkCard text-white' : 'bg-white text-slate-900'}`}>
                                <div className={`absolute top-0 left-0 w-full h-2 bg-gradient-to-r ${theme.primary}`}></div>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold">{currentTask ? 'تعديل' : 'إضافة'}</h3>
                                    <button onClick={() => setIsModalOpen(false)} className="p-2 hover:bg-slate-100 dark:hover:bg-white/10 rounded-full"><Icon name="x" /></button>
                                </div>
                                <form onSubmit={handleSave} className="space-y-5">
                                    <div>
                                        <label className="text-xs font-bold opacity-50 uppercase mb-2 block">العنوان</label>
                                        <input required autoFocus value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className={`w-full p-4 rounded-2xl bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 outline-none focus:ring-2 ${theme.ring}`} placeholder="اسم المهمة" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold opacity-50 uppercase mb-2 block">من</label>
                                            <input type="time" required value={formData.startTime} onChange={e => setFormData({...formData, startTime: e.target.value})} className={`w-full p-4 rounded-2xl bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 outline-none focus:ring-2 ${theme.ring}`} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold opacity-50 uppercase mb-2 block">إلى</label>
                                            <input type="time" required value={formData.endTime} onChange={e => setFormData({...formData, endTime: e.target.value})} className={`w-full p-4 rounded-2xl bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 outline-none focus:ring-2 ${theme.ring}`} />
                                            {/* Helper text showing duration calculation in modal */}
                                            <p className="text-[10px] mt-2 opacity-50 flex items-center gap-1">
                                                <Icon name="clock" size={10}/>
                                                المدة: {formatDuration(getDurationMins(formData.startTime, formData.endTime))}
                                                {formData.endTime < formData.startTime && <span className="text-indigo-500 font-bold">(لليوم التالي)</span>}
                                            </p>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold opacity-50 uppercase mb-2 block">التصنيف</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {categories.map(cat => (
                                                <button type="button" key={cat.id} onClick={() => setFormData({...formData, category: cat.id})} className={`p-3 rounded-xl border text-xs font-bold flex flex-col items-center gap-2 transition-all ${formData.category === cat.id ? `bg-gradient-to-br ${theme.primary} text-white border-transparent shadow-md` : `border-slate-200 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/5`}`}>
                                                    <Icon name={cat.icon} size={18} /> {cat.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold opacity-50 uppercase mb-2 block">ملاحظات</label>
                                        <textarea value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} className={`w-full p-4 rounded-2xl bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 outline-none focus:ring-2 ${theme.ring}`} rows="2"></textarea>
                                    </div>
                                    <div className="flex gap-4 pt-2">
                                        {currentTask && <button type="button" onClick={() => { setTasks(tasks.filter(t => t.id !== currentTask.id)); setIsModalOpen(false); }} className="p-4 rounded-2xl text-red-500 bg-red-500/10"><Icon name="trash-2" /></button>}
                                        <button type="submit" className={`flex-1 py-4 rounded-2xl text-white font-bold shadow-lg bg-gradient-to-r ${theme.primary} hover:opacity-90 transition-all`}>حفظ</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* --- Settings Modal --- */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-pop no-print">
                            <div className={`w-full max-w-lg rounded-3xl shadow-2xl flex flex-col max-h-[85vh] ${darkMode ? 'bg-darkCard text-white' : 'bg-white text-slate-900'}`}>
                                <div className="p-6 border-b border-slate-100 dark:border-white/10 flex justify-between items-center">
                                    <h3 className="font-bold text-xl">إدارة التصنيفات</h3>
                                    <button onClick={() => setIsSettingsOpen(false)}><Icon name="x" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scroll">
                                    {categories.map(cat => (
                                        <div key={cat.id} className={`flex justify-between items-center p-4 rounded-2xl ${darkMode ? 'bg-black/20' : 'bg-slate-50'}`}>
                                            <div className="flex items-center gap-4">
                                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${CAT_STYLES[cat.styleIdx % CAT_STYLES.length].bg} ${CAT_STYLES[cat.styleIdx % CAT_STYLES.length].text}`}><Icon name={cat.icon} size={20}/></div>
                                                <span className="font-bold text-lg">{cat.label}</span>
                                            </div>
                                            <button onClick={() => { if(categories.length > 1) setCategories(categories.filter(c => c.id !== cat.id)); else alert('يجب بقاء تصنيف واحد على الأقل'); }} className="text-red-500 opacity-50 hover:opacity-100 p-2"><Icon name="trash-2" /></button>
                                        </div>
                                    ))}
                                    <div className={`p-5 rounded-2xl border-2 border-dashed ${darkMode ? 'border-white/10 bg-white/5' : 'border-slate-200 bg-slate-50/50'} mt-6`}>
                                        <p className="text-xs font-bold opacity-50 uppercase mb-4">إضافة جديد</p>
                                        <CategoryForm addCategory={(newCat) => setCategories([...categories, { ...newCat, id: generateId() }])} theme={theme} darkMode={darkMode}/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Sub-component for Category Form logic
        const CategoryForm = ({ addCategory, theme, darkMode }) => {
            const [newCat, setNewCat] = useState({ label: '', styleIdx: 0, icon: 'circle' });
            return (
                <>
                    <input value={newCat.label} onChange={e => setNewCat({...newCat, label: e.target.value})} placeholder="الاسم..." className={`w-full p-3 mb-4 rounded-xl bg-transparent border ${darkMode ? 'border-white/20' : 'border-slate-300'}`} />
                    <div className="flex gap-2 mb-4">{CAT_STYLES.map((s, i) => <button key={i} onClick={() => setNewCat({...newCat, styleIdx: i})} className={`w-8 h-8 rounded-full ${s.bg} border-2 ${newCat.styleIdx === i ? `border-current ${s.text}` : 'border-transparent'}`}></button>)}</div>
                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2">{ICONS.map(ic => <button key={ic} onClick={() => setNewCat({...newCat, icon: ic})} className={`p-2 rounded-lg border ${newCat.icon === ic ? `bg-slate-800 text-white dark:bg-white dark:text-black border-transparent` : `border-transparent hover:bg-slate-200 dark:hover:bg-white/10`}`}><Icon name={ic} size={18}/></button>)}</div>
                    <button onClick={() => { if(newCat.label) { addCategory(newCat); setNewCat({label:'', styleIdx:0, icon:'circle'}); }}} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r ${theme.primary}`}>إضافة</button>
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

